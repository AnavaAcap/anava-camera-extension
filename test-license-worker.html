<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test License Worker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #333; }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover { background: #45a049; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 3px;
      border-bottom: 1px solid #eee;
    }
    .log-error { color: red; }
    .log-success { color: green; }
    .log-info { color: blue; }
  </style>
</head>
<body>
  <h1>Test Axis License Worker</h1>

  <div>
    <h2>Test Configuration</h2>
    <label>Device ID (MAC without colons):</label><br>
    <input type="text" id="deviceId" value="B8A44F914D20" style="width: 300px; padding: 5px; margin: 5px 0;"><br>

    <label>License Key:</label><br>
    <input type="text" id="licenseKey" value="XXH76-UJPMU-BXKEX-EQ5ZY" style="width: 300px; padding: 5px; margin: 5px 0;"><br>
  </div>

  <div>
    <button id="testBtn">Test License Generation</button>
    <button id="clearBtn">Clear Log</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    const logDiv = document.getElementById('log');
    const testBtn = document.getElementById('testBtn');
    const clearBtn = document.getElementById('clearBtn');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    clearBtn.addEventListener('click', () => {
      logDiv.innerHTML = '';
      log('Log cleared', 'info');
    });

    testBtn.addEventListener('click', async () => {
      const deviceId = document.getElementById('deviceId').value;
      const licenseKey = document.getElementById('licenseKey').value;

      if (!deviceId || !licenseKey) {
        log('ERROR: Please provide both Device ID and License Key', 'error');
        return;
      }

      testBtn.disabled = true;
      log('Starting license generation test...', 'info');
      log(`Device ID: ${deviceId}`, 'info');
      log(`License Key: ${licenseKey}`, 'info');

      try {
        // Step 1: Check if extension is loaded
        log('Step 1: Checking extension connection...', 'info');

        if (typeof chrome === 'undefined' || !chrome.runtime) {
          throw new Error('Chrome extension API not available - is this page opened from the extension?');
        }

        // Step 2: Try to send message to background script
        log('Step 2: Sending test message to background...', 'info');

        const response = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('Timeout waiting for response'));
          }, 35000);

          chrome.runtime.sendMessage(
            {
              command: 'generate_license',
              payload: { deviceId, licenseKey }
            },
            response => {
              clearTimeout(timeout);

              if (chrome.runtime.lastError) {
                reject(new Error(chrome.runtime.lastError.message));
                return;
              }

              resolve(response);
            }
          );
        });

        log('Step 3: Received response from license worker', 'info');

        if (response.success) {
          log(`SUCCESS! License XML generated (${response.licenseXML.length} bytes)`, 'success');
          log('First 200 chars of XML:', 'info');
          log(response.licenseXML.substring(0, 200), 'info');
        } else {
          log(`ERROR: ${response.error}`, 'error');
        }

      } catch (error) {
        log(`EXCEPTION: ${error.message}`, 'error');
        console.error(error);
      } finally {
        testBtn.disabled = false;
      }
    });

    // Initial log
    log('Test page loaded. Click "Test License Generation" to start.', 'info');
  </script>
</body>
</html>
