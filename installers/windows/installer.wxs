<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*"
           Name="Anava Local Connector"
           Language="1033"
           Version="2.0.0"
           Manufacturer="Anava Technologies"
           UpgradeCode="12345678-1234-1234-1234-123456789012">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perUser"
             Description="Anava Local Connector for Chrome Extension"
             Comments="Provides local network access for camera deployment" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <!-- Feature: Main Installation -->
    <Feature Id="MainFeature" Title="Anava Local Connector" Level="1">
      <ComponentGroupRef Id="BinaryComponents" />
      <ComponentGroupRef Id="RegistryComponents" />
      <ComponentGroupRef Id="StartupComponents" />
    </Feature>

    <!-- Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- User's Local AppData -->
      <Directory Id="LocalAppDataFolder">
        <Directory Id="AnavaFolder" Name="Anava">
          <Directory Id="INSTALLFOLDER" Name="LocalConnector">
            <!-- Binary will be placed here -->
          </Directory>
        </Directory>
      </Directory>

      <!-- Chrome Native Messaging Host manifest location -->
      <Directory Id="AppDataFolder">
        <Directory Id="GoogleFolder" Name="Google">
          <Directory Id="ChromeFolder" Name="Chrome">
            <Directory Id="NativeMessagingHostsFolder" Name="NativeMessagingHosts">
              <!-- Manifest will be placed here -->
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Binary Components -->
    <ComponentGroup Id="BinaryComponents" Directory="INSTALLFOLDER">
      <Component Id="LocalConnectorBinary" Guid="11111111-1111-1111-1111-111111111111">
        <File Id="LocalConnectorExe"
              Source="local-connector.exe"
              KeyPath="yes"
              Checksum="yes" />
      </Component>
    </ComponentGroup>

    <!-- Registry Components for Native Messaging -->
    <ComponentGroup Id="RegistryComponents" Directory="NativeMessagingHostsFolder">
      <Component Id="NativeMessagingHostManifest" Guid="22222222-2222-2222-2222-222222222222">
        <File Id="NativeMessagingHostJson"
              Source="com.anava.local_connector.json"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Startup Components (Run on Login) -->
    <ComponentGroup Id="StartupComponents" Directory="INSTALLFOLDER">
      <Component Id="StartupRegistryKey" Guid="33333333-3333-3333-3333-333333333333">
        <!-- Add registry key to start proxy service on login -->
        <RegistryKey Root="HKCU"
                     Key="Software\Microsoft\Windows\CurrentVersion\Run">
          <RegistryValue Type="string"
                         Name="AnavaLocalConnector"
                         Value="&quot;[INSTALLFOLDER]local-connector.exe&quot; --proxy-service"
                         KeyPath="yes" />
        </RegistryKey>
      </Component>
    </ComponentGroup>

    <!-- UI Configuration -->
    <UIRef Id="WixUI_Minimal" />
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

    <!-- Custom actions to start service after install -->
    <CustomAction Id="StartProxyService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]local-connector.exe --proxy-service"
                  Execute="deferred"
                  Impersonate="yes"
                  Return="asyncNoWait" />

    <InstallExecuteSequence>
      <Custom Action="StartProxyService" After="InstallFinalize">NOT REMOVE</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
